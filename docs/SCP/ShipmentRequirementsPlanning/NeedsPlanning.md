# Планирование потребностей

Для настройки АРМа **"Планирование потребностей"** заполняется [**"Сценарий планирования потребностей"**](NeedsPlanningScenarios.md), автоматически заполнятся период и настройки:

[![1][1]][1]

Вкладка **"Отгрузки"** будет заполнена товарами, в которых есть потребность на выбранный период и отвечающими настройкам.

Номенклатуры можно детализировать в табличной части до характеристики, склада, волны и даты выпуска. Также для каждой номенклатуры будет выведен артикул.  

Дата выпуска - это минимально рекомендованная дата выпуска продукции с учетом срока годности номенклатуры и %ОСГ.

> Дата выпуска вычисляется по формуле: Дата выпуска = Дата отгрузки - Срок годности + Сдвиг даты

Дата отгрузки - планируемая дата отгрузки, указанная в Заказе/Пред Заказе.

Срок годности - количество дней, указанных в карточке номенклатуры.

Сдвиг даты = округлить(Срок годности * (%ОСГ/100)). Это сдвиг вправо от минимально возможной даты изготовления продукции, пригодной для продажи. 

%ОСГ подставляется следующим образом:

- если в Заказе/Пред заказе/Прогнозе/Акционной отгрузке указана точка доставки, то %ОСГ берется из регистра "Разрешенные ОСГ товаров" по номенклатуре и точке доставки;
- если не указана точка доставки или не указан %ОСГ по точке доставки, то берется общий %ОСГ из контрагента;
- если %ОСГ не указан ни по точке доставки, ни по контрагенту, то %ОСГ берется по умолчанию из [**"Сценария планирования потребностей"**](NeedsPlanningScenarios.md).

Например: Дата отгрузки - 31.03; Срок годности - 15 дней; %ОСГ - 90%.

Тогда Сдвиг даты = 15 * 0,9 = 13,5. Округление до 14. Затем Дата выпуска = 31.03 - 15 + 14 = 30.03

 Для каждой номенклатуры будут заполнены поля:

- Пр-з отгрузки – заполняется на основании документов **"Прогноз отгрузок"**
- Прогноз на дату отгрузки – рассчитывается на основании данных из документов "Заказ клиента" по тому же дню недели, что и день отгрузки, и за то количество недель назад, что указано в "Правилах расчета отгрузок": 

    [![6][6]][6]

    Для расчета проверяется, был ли заказ акционным. То есть существует ли в системе документ "Акционные отгрузки" по указанной точке доставки и номенклатуре на дату отгрузки или дату заказа. Эта дата зависит от указанных ценовых условий - цена на дату отгрузки/на дату заказа: 

    [![7][7]][7]

    Если существует, то из количества в "Заказе" вычитаются приросты продаж, указанные в "Акционных отгрузках" по дате отгрузки или дате заказа. Далее для каждого дня объемы суммируются по точке доставки и номенклатуре. Затем Прогноз для номенклатуры и точки доставки считается по формуле:

    `Прогноз = (Очищенный объем за 1 день + ... + Очищенный объем за n-ый день) / Количество недель в "Правилах расчета отгрузок"`

    Например, возьмем три номенклатуры и сделаем 4 заказа на 4 субботы апреля:

    [![8][8]][8] 

    «Ассорти из мяса» и «Бедро любительское» относятся к товарной категории «Первая свежесть», у которой в правилах расчета отгрузок стоит период 4 недели. У «Кефира» товарная категория «Молочная продукция», период отсутствует (по умолчанию – 3 недели).
    
    Заказано (важно: в расчете учитываются только исходные данные из первоначального вида заказа, любые изменения не идут в расчет):

    - «Ассорти из мяса» - 0 (26.04), 500 (19.04), 500 (12.04), 500 (5.04) шт
    
    - «Бедро любительское» - 900, 900, 900, 900 шт
    
    - «Кефир» - 700, 700, 700, 700 шт
    
    Цена: на дату заказа.

    Точка доставки: во всех заказах одна, от одного контрагента.

    Акционных отгрузок ни по одной номенклатуре не было.
    
    Расчет Прогноза идет по формулам:

    - «Ассорти из мяса»: (0+500+500+500)/4= 375

    - «Бедро любительское»: (900+900+900+900)/4= 900

    - «Кефир»: (700+700+700)/3= 700 (не учитывается заказ на 5.04, т. к. период 3 недели)

    Эти значения отобразятся в АРМе в периоде 03.05 (суббота) в колонке Прогноз напротив Даты выпуска для соответствующих номенклатур при выборе соответствующего сценария на нужные даты. 

    [![9][9]][9]

    Также есть опция для расчета прогноза по неделям (в Сценарии планирования потребностей):

    Для каждой недели из «Правил расчета отгрузок» суммируется количество из заказов по всем дням в неделе (в разрезе номенклатуры, характеристики и точки доставки) и затем вычитаются приросты из «Акционных отгрузок» по датам отгрузки. Затем прогноз для одной номенклатуры рассчитывается по формуле:

    `Прогноз = (Очищенный объем за 1 неделю + ... + Очищенный объем за n-ую неделю) / Количество недель в «Правилах расчета отгрузок»`

    Номенклатуры, выведенные из ассортимента, исключаются из Прогноза для дат из "Сценария планирования потребностей", которые больше или равны дате выведения из ассортимента.


- Пред. заказ – заполняется на основании документов **"Предварительные заказы"**
- Заказы – заполняется на основании документов **"Заказы клиентов"** (заказы в состоянии "Закрыт" не учитываются)

[![2][2]][2]

Заполнить план потребностей можно несколькими способами, выбрав из выпадающего списка **"Сделать"** один из вариантов:

- Заполнить план по правилу – план заполняется по правилу расчета отгрузок
- Заполнить план по сохраненному плану
- Заполнить план по прогнозу отгрузки
- Заполнить план по прогнозу
- Заполнить план по предварительным заказам
- Заполнить план по заказам

Либо можно изменить план вручную:

- Изменить план на процент
- Округлить план до кратности
- Установить конкретное значение

После выбора варианта заполнения нужно выбрать строки для заполнения, а затем нажать кнопку **"Выполнить"**, будет заполнена колонка **"План"** в таблице. Если в карточке номенклатуры была указана кратность, а число в колонке "План" в результате вытеснения данных рассчитывается не кратным, то оно всегда округляется по кратности номенклатуры в большую сторону. 

[![3][3]][3]

У колонок Заказ, Пред. заказ и Прогноз реализовано вытеснение данных по приоритету: Заказ вытесняет Пред. заказ, Пред. заказ вытесняет Прогноз (также Заказ вытесняет и Прогноз). Это вытеснение происходит в разрезе одной точки доставки, т. е. если Прогноз/Пред. Заказ/Заказ построен по одной точке доставки, то вытеснение данных будет реализовано в рамках этой точки доставки.

После заполнения колонки **"План"**, на вкладке **"Расчет"** показана полная статистика по планируемым отгрузкам. Указаны нечисловые данные: период отгрузки, волна, номенклатура, характеристика, базовый продукт, сезоннаяя группа, склад, правило, по которому рассчитывалось число отгрузки. Указаны также числовые данные, которые перенеслись из вкладки **"Отгрузки"**.

[![4][4]][4]

Для формирования плана потребностей нужно нажать кнопку **"Сохранить"**, система подставит его в поле "Сохраненный план". Если меняем уже существующий, то также нажимаем кнопку **"Сохранить"**.

В результате сформируется документ **"План потребностей"** на указанный период.

[![5][5]][5]

"Планы потребностей" также могут вытеснять друг друга по следующей логике:

- например, был создан План потребностей 1 на период с 1.01 по 10.01 по Сценарию 1 по Товарной категории 1
- далее был создан План потребностей 2 на период с 6.01 по 12.01 по Сценарию 2 по Товарной категории 1
- товарная категория в этих документах одинаковая, поэтому второй документ вытеснит первый по отгрузкам в периоде с 6.01 по 10.01 по Товарной категории 1

Вытеснение означает, что новый созданный документ "План потребностей" по товарной категории будет приоритетнее предыдущего по этой же товарной категории. А совпадающие значения по дате отгрузки предыдущего документа перестают быть активными. Вытеснение идет по дате потребности и товарной категории.

[1]: NeedsPlanning.assets/1.png
[2]: NeedsPlanning.assets/2.png
[3]: NeedsPlanning.assets/3.png
[4]: NeedsPlanning.assets/4.png
[5]: NeedsPlanning.assets/5.png
[6]: NeedsPlanning.assets/6.png
[7]: NeedsPlanning.assets/7.png
[8]: NeedsPlanning.assets/8.png
[9]: NeedsPlanning.assets/9.png